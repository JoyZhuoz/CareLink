# Elastic Agent Builder: CareLink Tools Setup

Use this guide to add the two retrieval tools in the **Elastic Cloud / Kibana Agent Builder** dashboard so the triage agent can read Perplexity-embedded docs and decide next questions.

---

## Where to go

1. Open **Kibana** (or Elastic Cloud console) for your deployment.
2. Go to **Machine Learning** → **Agent Builder** (or **Search** → **Agent Builder**, depending on your UI).
3. Open your **CareLink Triage Agent** (or create one and paste the system prompt from `config/agent-builder-config.js`).

---

## Tool 1: Get this patient’s Perplexity recovery doc

**Purpose:** Fetch the expected recovery text (and metadata) for the current patient so the agent can compare reported symptoms to “normal” and “warning signs.”

| Field | Value |
|--------|--------|
| **Type** | ES|QL |
| **Tool ID** | `search_patient_recovery_context` |
| **Name** | Search patient recovery context |
| **Description** | Fetch the expected recovery document for a specific patient. This document was generated by Perplexity and contains normal expected symptoms, warning signs requiring medical attention, and typical pain/mobility expectations for their surgery type. Use this BEFORE making any triage decision. |

**Parameter**

| Parameter name | Type | Required |
|----------------|------|----------|
| `patient_id` | keyword | Yes |

**ES|QL query** (paste as-is; the `?patient_id` is filled by the agent):

```esql
FROM patients
| WHERE patient_id == ?patient_id
| KEEP patient_id, name, surgery_type, surgery_date, discharge_date, risk_factors, expected_response_text
| LIMIT 1
```

Save the tool, then assign it to your CareLink agent.

---

## Tool 2: Find similar patients (vector search on Perplexity embeddings)

**Purpose:** Find other patients whose expected recovery profiles are similar to the reported symptoms (KNN on `expected_response_embedding`) so the agent can use similar cases to inform the next question and triage.

| Field | Value |
|--------|--------|
| **Type** | ES|QL |
| **Tool ID** | `search_similar_patient_cases` |
| **Name** | Search similar patient cases |
| **Description** | Search for patients with similar expected recovery profiles using vector similarity. Use the symptoms the patient reported (e.g. "fever, knee swelling, redness"). Returns similar patients and their expected recovery docs for comparison. |

**Parameter**

| Parameter name | Type | Required |
|----------------|------|----------|
| `symptoms` | text | Yes |

**ES|QL query** (paste as-is; `?symptoms` is filled by the agent; embedding uses your inference endpoint):

```esql
FROM patients METADATA _score
| WHERE KNN(expected_response_embedding, TEXT_EMBEDDING(?symptoms, "carelink-e5-embedding"))
| KEEP patient_id, name, surgery_type, risk_factors, expected_response_text
| SORT _score DESC
| LIMIT 3
```

**Important:** The inference ID must match the endpoint you created in Elasticsearch (the one used by `embeddingService.js`). We use **`carelink-e5-embedding`**. If your endpoint has a different ID, replace it in the query above.

Save the tool, then assign it to your CareLink agent.

---

## Checklist

- [ ] Agent Builder → your CareLink agent opened.
- [ ] **New tool** → Type: **ES|QL**.
- [ ] Tool 1: ID `search_patient_recovery_context`, param `patient_id`, query as in “Tool 1” above → **Save**.
- [ ] **New tool** again → Type: **ES|QL**.
- [ ] Tool 2: ID `search_similar_patient_cases`, param `symptoms`, query as in “Tool 2” above (with correct inference ID) → **Save**.
- [ ] **Assign** both tools to the CareLink agent.
- [ ] System prompt in the agent matches the one in `config/agent-builder-config.js` (it tells the agent to call these two tools by name and use their results for next_question and triage).
- [ ] Save the agent; deploy/copy the endpoint URL and API key into `.env` (`ES_AGENT_BUILDER_ENDPOINT`, `ES_AGENT_BUILDER_API_KEY`).

After this, the agent can retrieve from Perplexity-embedded docs and use them to inform the next questions and triage.
